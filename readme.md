# Шлюз для запроса баланса из программы MobileBalance без Internet Explorer.
шлюз дает возможность писать собственные скрипты на любом языке и уходит от ограничений IE для javascript.
Т.к. mobilebalance меньше дергает IE он меньше подвисает и падает.
Можно сохранять сессии, т.е. на каждый телефон tele2 у вас будет своя сессия с сохраненными куками.
Все собрано таким образом чтобы не оказывать никакого влияния на установленные программы, в т.ч. если установлен python другой версии.
Есть два варианта использования вызов через DLL - dllplugin плагин и вызов через локальный вебсервер jsmblhplugin. 
Т.к. у версии dllplugin обнаружился недостаток в виде того что MobileBalance принимает из dllplugin ограниченное количество параметров, то в настоящий момент приоритетной является версия с вебсервером - jsmblhplugin, хотя если вам нужен только баланс и какие-то базовые вещи, то никто не мешает использовать и dllplugin.

# Короткая инструкция 
Свежую версию сборки можно найти в [releases](https://github.com/artyl/mbplugin/releases) на github или в форуме на [4pda](https://4pda.ru/forum/index.php?showtopic=985296) посвященном MobileBalance.  
Распаковать свежую версию сборки в папку где установлен MobileBalance.
Запустить из папки mbplugin setup_and_check.bat
Подключить нужные плагины из папки mbplugin\jsmblhplugin
Можно пользоваться.

# Кроме простого использования есть еще
Запись в базу sqlite 
Импорт данных из mdb базы mobilebalanse в БД sqlite (необходима установка odbc драйвера для mdb)
В случае включения записи в базу sqlite можно в вебсервере также просматривать отчеты по балансам и генерировать html отчет

## Установка
### Установка Вариант 1 Готовый архив (простой)
Архив можно найти в [releases](https://github.com/artyl/mbplugin/releases) на github или в форуме на [4pda](https://4pda.ru/forum/index.php?showtopic=985296) посвященном MobileBalance.  
Архив желательно распаковать в папку, в которой находится MobileBalance (приоритерный вариант), после установки запустить setup_and_check.bat, он пересобирет DLL для плагинов, создаст настроечный файл mbplugin.ini и запустит тестовый плагин p_test1, для проверки, что все установлено правильно.  
Все настройки теперь сохраняются в файле mbplugin.ini, он создается в папке& где находятся остальные ini файлы mobilebalance, а либо если setup_and_check.bat их не нашел, то в папке mbplugin.  

### Установка Вариант 2 Из github 
Склонировать репозиторий c github
``` 
git clone <https://github.com/artyl/mbplugin>
```
загрузить и распаковать tcc и python:  
```
tcc\get_tcc.bat  
python\get_python.bat  
```
tkinter для python, если нужен ввод капчи для python к сожалению автоматом поставить не получиться, нашел только [такой способ](https://stackoverflow.com/questions/37710205/python-embeddable-zip-install-tkinter)  
Сборка всех DLL: dllsource\compile_all_p.bat  
После этого все DLL будут находится в папке mbplugin\dllplugin  
Если есть желание использовать свой питон, тогда можно поменять вызов в mbplugin\plugin\mbplugin.bat

### mbplugin.ini
Если архив был распакован в одну из папок в папке MobileBalance то при первом запуске (setup_and_check.bat) в папке, где находится mobilebalance.exe будет создан mbplugin.ini с дефолтовыми минимальными настройками (по умолдчанию все доп фишки выключены).
Если архив распакован не в папку с mobilebalance, то прижелании получить дополнительный функционал необходимо в секции [MobileBalance] path прописать путь в папку с mobilebalance  
Что можно включить:
sqlitestore = 1 - запись запросов в sqlite БД, ghbxtv пишуться все поля, напримет те же SMS, которые не принимает MobileBalance через DLL, sqlite БД по умолчанию находится в папк mobilebalance, но при желании это путь можно изменить в параметре dbfilename
createhtmlreport = 1 - после каждого вызова mbplugin создавать файл с отчетом, сходный с html страничкой, которую mobilebalance умеет отдавать в виде html. Список полей в отчете можно поменять в переменной table_format, только не трогайте на первых двух местах PhoneNumber,Operator, иначе сломается. Пока не придумал как по другому.
Местоположение отчета по умолчанию - в папке mbplugin\db\balance.html, если хотите в другое место - меняйте параметр balance_html

## Использование.
Теперь есть два варианта использования dllplugin и jsmblhplugin (jsmb localhost)
### dllplugin
Для использования в MobileBalance подключить нужный dll плагин из папки mbplugin\dllplugin
Вызов плагина осуществляется через вызов DLL, плюс - минимальное участие IE, минус MB не все поля принимает обратно  
Пути, жестко прописываются в DLL, в готовой сборке они смотрят в C:\mbplugin, если ваша папка отличается от этой, то запустите dllsource\compile_all_p.bat  
Подключить DLL для нужных провайдеров (Настройки\Плагины\Операторы Добавить и выбрать DLL для нужных операторов)
В настройках для соответсвующего телефона выбрать провайдера соответствующей DLL
### jsmblhplugin
Для использования добавить в автозагрузку mbplugin\plugin\run_webserver.bat и  подключить нужный плагин из папки mbplugin\jsmblhplugin  
Вызов осуществляется через jsmb плагин, который передает параметры в webserver, который в свою очередь уже вызывает сам плагин. Плюсы - получаем все поля, которые могли использовать в jsmb плагинах, минусы - необходимо запускать webserver, также в этой схеме больше участия IE, и возможно глюков от замусоренного кэша IE будет больше.  
! ВАЖНО ! Не забывайте, что для работы jsmblhplugin должен быть запущен web server mbplugin\plugin\run_webserver.bat (при звпущенном webserver появляется иконка в трее)

## На данный момент реализованы плагины:
(Источником информации послужили как собственное изучение так и существующие плагины, так что пользуясь случаем хочу выразить благодарность всем авторам
leha3d Pasha comprech y-greek и другим, кто тратил свои силы и время на реверс сайтов операторов и разработку)  
test1 - Простой тест с демонстрацией всех полей (MB из DLL принимает далеко не все Balance Expired Min Internet TarifPlan BlockStatus AnyString)  
test2 - Пример реализации ввода капчи  
mts - МТС  
beeline - Билайн  
megafon - Мегафон  
tele2 - ТЕЛЕ2  
strelka - Баланс карты стрелка  
zadarma - Zadarma.com (IP телефония)  
cardtel - Cardtel (IP телефония)  
sodexo - Получение баланса карты Sodexo (подарочные карты)  
usd - Курс доллара с RBC  
eur - Курс евро с RBC  
financeyahoo - Курс ценных бумаг с finance.yahoo.com  
moex - Курс ценных бумаг с moex.com  
stock - Рассчет цены портфеля ценных бумаг  
sipnet - Sipnet (IP телефония)  
avtodor-tr - Автодор транспондер  
smile-net - Infoline/smile-net/Virgin connect (Интернет провайдер)  
parking_mos - parking.mos.ru оплата парковки (Вход через логин/пароль на login.mos.ru)

## дополнительные фишки 
### mbplugin.ini
В файле mbplugin.ini можно включить дополнительные возможности.  
Если выставить sqlitestore = 1 и createhtmlreport = 1, то после каждого получения баланса будет генерироваться файл db\balance.html максимально близкий по виду к файлу который генерирует MobileBalance, но только по по тем телефонам, баланс которых мы получаем через mbplugin. Также все данные получаемые через mbplugin сохраняются в базу SQLITE схожей структуры с BalanceHistory.mdb. Данная возможность позволяет видеть те поля, которые не принимает MobileBalance из DLL плагинов, наприимер количество SMS.  
Для использования этих возможностей убедитесь, что в файле mbplugin.ini в разделе [MobileBalance] параметр path указывает на папку где находится mobilebalance.exe  
Если вы распаковали архив в подпапку в папке с MobileBalance то path должен настроиться автоматически.
### веб сервер
Веб сервер нужен для jsmbLH плагинов (запускается mbplugin\plugin\run_webserver.bat), а кроме этого если включить режим записи в БД, то через web сервер становиться доступен просмотр отчетов по телефонам, полученным через mbplugin [report](http://localhost:8000/report)  

## Как проверить что все работает
### ВАЖНО! 
DLL собраны 32 битном компиляторе, и вызываться должны из 32 битного приложения 32 битную DLL вызвать из 64 битного приложения нельзя.  
### Проверка самих плагинов
запустите из mbplugin\plugin:  
test_mbplugin_login_pass.bat p_test1 login password  
Если в консоль будет выведен XML, то скорее всего у вас все работает:
```
<Response><Balance>124.45</Balance> .... </Response>
```
Таким же образом можно проверить любой плагин:
C:\mbplugin\plugin\test_mbplugin_login_pass.bat p_[имя плагина на python] [логин] [пароль]
### Проверка DLL
запустите из mbplugin\plugin:  
plugin\test_mbplugin_dll_call.bat test1 123 456  
Должен выдать XML с инфо о плагине и XML с балансом
При желании так можно проверить любую DLL но учитывая, что они собираются пачкой, то и с остальными все ок.  
Если возникли ошибки, попробуйте выполнить dllsource\compile_all_p.bat
### Проверка jsmb localhost
Можно открыть нужный плагин из mbplugin\jsmblhplugin в редакторе jsmb плагинов в MobileBalance - Плагины\Операторы\Создать/редактировать плагин.
Другой вариант проверки - открыть в браузере http://127.0.0.1:8000/getbalance/p_плагин/логин/пароль/случайное_число, вот так например http://127.0.0.1:8000/getbalance/p_test1/123/456/789

## Как это работает
Mobilebalance вызывает DLL передавая ей логин и пароль через xml строку
В самой DLL никакого функционала нет, она служит лишь оберткой для передачи вызова в mbplugin\plugin\mbplugin.bat  
DLL вызывает mbplugin\plugin\mbplugin.bat передавая ему имя плагина в качестве параметра, а переданный XML через переменную окружения RequestVariable
mbplugin.bat вызывает mbplugin.py в котором вызывается соответсвующий python плагин.
mbplugin.bat возвращает результат через stdout.

## Почему так сделано.
Данные по параметрам вызова DLL были получены с помощью реверса существующего DLL плагина.
Я постарался сделать все так, чтобы все можно было собрать за 10 минут не устанавливая 10 гигабайтные компиляторы, минималистичная DLL весь код вынесен в скрипты.
Конечно DLL можно собрать и на vc и gpp и на Delphi и много на чем еще,
но для этого нужно много возни с установкой среды, в моем варианте все можно собрать с нуля за 10 минут скачав несколько десятков мегабайт.  
Количество кода для DLL минимум, чтобы любой  желающий мог без труда убедится что в нем нет закладок.

Остальной код на скриптах, и его можно проверить в любой момент.
C я знаю не очень хорошо, поэтому единственный простой способ передать request я нашел через переменную окружения, а возврат осуществляется через поток вывода.
Пути в папке mbplugin внутри DLL приходится прописывать абсолютными, потому что из DLL выяснить по какому пути она находится оказалось очень нетривиальной задачей, даже имя DLL узнать очень непросто. В принципе это проблема небольшая на tcc все пересобирается за пару секунд.
Хотел сохранить настройки для путей в реестре, но из реестра прочитать оказалось тоже не просто.
В результате у меня получилось сделать только так, код на C получился не очень хороший, но работоспособный.
Если кто в состоянии причесать сишный код, буду признателен.
Вызов bat файла а не напрямую скрипта python сделан для того чтобы если будет желание отвязаться от python, с минимумом изменений в остальном коде.

Т.к. в запросе передается только логин и пароль, то нам приходится сделать по отдельной DLL для каждого сервиса
Чтобы оставить задел на будущее я для плагинов добавил еще префиксы, для питона это p_
Таким образом мы генерируем dll по следующему принципу:
Для python плагина tele2 - файл плагина tele2.py
tele2 - имя модуля на python который получает баланс
p_tele2.dll - dll которую мы подключаем в mobilebalance

В процессе эксплуатации выяснилось, что mobilebalance оказывается все поля  принимает из результата, как оказалось, например не понимает SMS,
Список принимаемых полей достаточно короткий:
Balance Expired Min Internet TarifPlan BlockStatus AnyString
Все кроме этого будет проигнорировано

Несмотря на то что на первый взгляд это все идет не через браузер mobilebalance все равно перед стартом DLL дергает движок IE (res://ieframe.dll/navcancl.htm и about:blank) - это видно по логу и появлению файлов в папке кэша IE, так что не исключаю, что часть каких-то глюков может по прежнему лечиться чисткой кэша браузера, хотя это и маловероятно.

## Как написать свой плагин
Если на python, то это файл с функцией get_balance(login, password, storename)
storename это строка, используемая как ключ для хранения сессии. Формируется как имя плагина + login
Функция возвращяет результат в виде словаря.
Можно посмотреть как сделаны другие плагины, также есть простые тестовые.
После того как плагин будет готов запускаем C:\mbplugin\dllsource\compile_all_p.bat и будут пересобраны DLL для всех имеющихся в папке C:\mbplugin\plugin плагинов.
Подключаем полученную DLL в MobileBalance и используем ее для получения баланса.

ВАЖНО. В xml который возвращает плагин поля case sensitive, так что если будет balance вместо Balance MB будет писать что баланс равен нулю.

--- Структура request который приходит из mobilebalance через переменную окружения ----------
```
<?xml version="1.0" encoding="windows-1251" ?>
<Request>
  <ParentWindow>007F09DA</ParentWindow>
  <Login>loginlogin</Login>
  <Password>password123456</Password>
</Request>
```
---- В mobilebalance уходит xml через вывод на экран -------------
```
<Response><Balance>123</Balance></Response>
```
